# Automatic PR Code Cleanup using Sandbox Cleanup Application
# This workflow automatically applies Eclipse JDT cleanup transformations to pull requests
# Uses the Docker-based action that wraps the sandbox cleanup application
#
# TEMPORARILY DISABLED: The Docker action has a build context issue that prevents it from working.
# See .github/actions/cleanup-action/TODO.md for details on the problem and investigation needed.
# This workflow will be re-enabled once the Docker build architecture is fixed.

name: Auto PR Cleanup

# Temporarily disabled - uncomment 'on:' section to re-enable
# on:
#   pull_request:
#     types: [opened, synchronize]
#     branches: [main]
#     paths:
#       - '**.java'

on:
  workflow_dispatch:  # Only allow manual triggering for now

permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event.pull_request.head.ref }}
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Run Sandbox Cleanup
      uses: ./.github/actions/cleanup-action
      with:
        config-file: '.github/cleanup-profiles/standard.properties'
        source-dir: '.'
        verbose: 'true'
        
    - name: Check for changes
      id: check_changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          git status --short
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Collect change details
      id: changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        # Anzahl ge√§nderter Dateien
        CHANGED_FILES=$(git status --porcelain | wc -l)
        echo "changed_count=$CHANGED_FILES" >> $GITHUB_OUTPUT
        
        # Liste der ge√§nderten Dateien (erste 20)
        CHANGED_LIST=$(git status --porcelain | awk '{print $2}' | head -20)
        echo "changed_list<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_LIST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Diff-Statistik
        git add -A
        DIFF_STAT=$(git diff --cached --stat | tail -1)
        echo "diff_stat=$DIFF_STAT" >> $GITHUB_OUTPUT
        
        # Kurze Diff-Vorschau (erste 100 Zeilen)
        DIFF_PREVIEW=$(git diff --cached --no-color | head -100)
        echo "diff_preview<<EOF" >> $GITHUB_OUTPUT
        echo "$DIFF_PREVIEW" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        git commit -m "üßπ Cleanup: Apply Eclipse JDT transformations (${{ steps.changes.outputs.changed_count }} files)" \
          -m "Ge√§nderte Dateien:" \
          -m "${{ steps.changes.outputs.changed_list }}"
        git push
        
    - name: Comment on PR
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: actions/github-script@v8
      with:
        script: |
          const changedCount = '${{ steps.changes.outputs.changed_count }}';
          const diffStat = '${{ steps.changes.outputs.diff_stat }}';
          const changedList = `${{ steps.changes.outputs.changed_list }}`;
          const diffPreview = `${{ steps.changes.outputs.diff_preview }}`;
          
          const changedFiles = changedList.split('\n')
            .filter(f => f.trim())
            .map(f => `- \`${f}\``)
            .join('\n');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '## üßπ Sandbox Cleanup Angewendet\n\n' +
                  '### Zusammenfassung\n' +
                  `- **Ge√§nderte Dateien:** ${changedCount}\n` +
                  `- **Statistik:** ${diffStat}\n\n` +
                  '### Ge√§nderte Dateien\n' +
                  changedFiles + '\n\n' +
                  '### Angewendete Transformationen\n' +
                  '- ‚ú® Code-Formatierung und Import-Organisation\n' +
                  '- üìù Fehlende Annotations hinzugef√ºgt (@Override, @Deprecated)\n' +
                  '- üßπ Unn√∂tigen Code entfernt (Casts, unbenutzte Variablen)\n' +
                  '- üöÄ Code modernisiert (Lambdas, funktionale Interfaces)\n' +
                  '- üîß Sandbox-spezifische Cleanups angewendet\n\n' +
                  '### Diff-Vorschau\n' +
                  '<details>\n' +
                  '<summary>Klicken um Diff anzuzeigen</summary>\n\n' +
                  '```diff\n' +
                  diffPreview + '\n' +
                  '```\n' +
                  '</details>\n\n' +
                  '**Profil:** standard\n\n' +
                  'Bitte die √Ñnderungen √ºberpr√ºfen.'
          })
