# Automatic PR Code Cleanup using Sandbox Cleanup Application
# This workflow automatically applies Eclipse JDT cleanup transformations to pull requests
# Uses the Docker-based action that wraps the sandbox cleanup application
#
# TEMPORARILY DISABLED: The Docker action has a build context issue that prevents it from working.
# See .github/actions/cleanup-action/TODO.md for details on the problem and investigation needed.
# This workflow will be re-enabled once the Docker build architecture is fixed.

name: Auto PR Cleanup

# Temporarily disabled - uncomment 'on:' section to re-enable
# on:
#   pull_request:
#     types: [opened, synchronize]
#     branches: [main]
#     paths:
#       - '**.java'

on:
  workflow_dispatch:  # Only allow manual triggering for now

permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event.pull_request.head.ref }}
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Run Sandbox Cleanup
      uses: ./.github/actions/cleanup-action
      with:
        config-file: '.github/cleanup-profiles/standard.properties'
        source-dir: '.'
        verbose: 'true'
        
    - name: Check for changes
      id: check_changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          git status --short
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Collect change details
      id: changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        # Anzahl geÃ¤nderter Dateien
        CHANGED_FILES=$(git status --porcelain | wc -l)
        echo "changed_count=$CHANGED_FILES" >> $GITHUB_OUTPUT
        
        # Liste der geÃ¤nderten Dateien (erste 20)
        CHANGED_LIST=$(git status --porcelain | awk '{print $2}' | head -20)
        echo "changed_list<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_LIST" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Diff-Statistik
        git add -A
        DIFF_STAT=$(git diff --cached --stat | tail -1)
        echo "diff_stat=$DIFF_STAT" >> $GITHUB_OUTPUT
        
        # Kurze Diff-Vorschau (erste 100 Zeilen)
        DIFF_PREVIEW=$(git diff --cached --no-color | head -100)
        echo "diff_preview<<EOF" >> $GITHUB_OUTPUT
        echo "$DIFF_PREVIEW" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create cleanup branch and commit changes
      id: create_branch
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create a unique cleanup branch name, sanitizing slashes in the base branch
        BASE_BRANCH="${{ github.event.pull_request.head.ref }}"
        SANITIZED_BASE_BRANCH="${BASE_BRANCH//\//-}"
        CLEANUP_BRANCH="cleanup/${SANITIZED_BASE_BRANCH}-${{ github.run_number }}"
        echo "cleanup_branch=$CLEANUP_BRANCH" >> $GITHUB_OUTPUT
        
        # Create and switch to cleanup branch
        git checkout -b "$CLEANUP_BRANCH"
        
        # Commit changes
        git add -A
        git commit -m "ğŸ§¹ Cleanup: Apply Eclipse JDT transformations (${{ steps.changes.outputs.changed_count }} files)" \
          -m "GeÃ¤nderte Dateien:" \
          -m "${{ steps.changes.outputs.changed_list }}"
        
        # Push to remote
        git push origin "$CLEANUP_BRANCH"
        
    - name: Create cleanup PR
      id: create_pr
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: actions/github-script@v8
      with:
        script: |
          const cleanupBranch = '${{ steps.create_branch.outputs.cleanup_branch }}';
          const baseBranch = '${{ github.event.pull_request.head.ref }}';
          const changedCount = '${{ steps.changes.outputs.changed_count }}';
          const diffStat = '${{ steps.changes.outputs.diff_stat }}';
          const changedList = `${{ steps.changes.outputs.changed_list }}`;
          const diffPreview = `${{ steps.changes.outputs.diff_preview }}`;
          
          const changedFiles = changedList.split('\n')
            .filter(f => f.trim())
            .map(f => `- \`${f}\``)
            .join('\n');
          
          // Create PR
          const prBody = '## ğŸ§¹ Sandbox Cleanup Vorschlag\n\n' +
                         '**Dies ist ein automatisch generierter Cleanup-PR.** Sie kÃ¶nnen diese Ã„nderungen:\n' +
                         '- âœ… **Akzeptieren**: Mergen Sie diesen PR\n' +
                         '- âŒ **Ablehnen**: SchlieÃŸen Sie diesen PR ohne zu mergen\n' +
                         '- âœï¸ **Anpassen**: Bearbeiten Sie die Dateien in diesem PR vor dem Merge\n\n' +
                         '### Zusammenfassung\n' +
                         `- **GeÃ¤nderte Dateien:** ${changedCount}\n` +
                         `- **Statistik:** ${diffStat}\n\n` +
                         '### GeÃ¤nderte Dateien\n' +
                         changedFiles + '\n\n' +
                         '### Angewendete Transformationen\n' +
                         '- âœ¨ Code-Formatierung und Import-Organisation\n' +
                         '- ğŸ“ Fehlende Annotations hinzugefÃ¼gt (@Override, @Deprecated)\n' +
                         '- ğŸ§¹ UnnÃ¶tigen Code entfernt (Casts, unbenutzte Variablen)\n' +
                         '- ğŸš€ Code modernisiert (Lambdas, funktionale Interfaces)\n' +
                         '- ğŸ”§ Sandbox-spezifische Cleanups angewendet\n\n' +
                         '### Diff-Vorschau\n' +
                         '<details>\n' +
                         '<summary>Klicken um Diff anzuzeigen</summary>\n\n' +
                         '```diff\n' +
                         diffPreview + '\n' +
                         '```\n' +
                         '</details>\n\n' +
                         '**Profil:** standard\n\n' +
                         `**Ziel-PR:** #${{ github.event.pull_request.number }}`;
          
          const { data: newPR } = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ§¹ Cleanup fÃ¼r PR #${{ github.event.pull_request.number }}: ${changedCount} Dateien`,
            head: cleanupBranch,
            base: baseBranch,
            body: prBody
          });
          
          core.setOutput('pr_number', newPR.number);
          core.setOutput('pr_url', newPR.html_url);
          return newPR.number;
        
    - name: Comment on original PR
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: actions/github-script@v8
      with:
        script: |
          const cleanupPrNumber = '${{ steps.create_pr.outputs.pr_number }}';
          const cleanupPrUrl = '${{ steps.create_pr.outputs.pr_url }}';
          const changedCount = '${{ steps.changes.outputs.changed_count }}';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ§¹ Cleanup-VorschlÃ¤ge VerfÃ¼gbar\n\n` +
                  `Der automatische Cleanup-Prozess hat **${changedCount} Dateien** analysiert und Verbesserungen gefunden.\n\n` +
                  `### ğŸ“‹ Cleanup-PR: #${cleanupPrNumber}\n` +
                  `ğŸ”— ${cleanupPrUrl}\n\n` +
                  `### Ihre Optionen:\n` +
                  `1. âœ… **Alle Ã„nderungen akzeptieren**: Mergen Sie PR #${cleanupPrNumber}\n` +
                  `2. âœï¸ **Ã„nderungen anpassen**: Bearbeiten Sie die Dateien in PR #${cleanupPrNumber} und mergen Sie dann\n` +
                  `3. âŒ **Ã„nderungen ablehnen**: SchlieÃŸen Sie PR #${cleanupPrNumber} und fahren Sie mit Ihrem ursprÃ¼nglichen PR fort\n\n` +
                  `Der Cleanup-PR enthÃ¤lt detaillierte Informationen Ã¼ber alle vorgeschlagenen Ã„nderungen.`
          })

