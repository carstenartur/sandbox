# This workflow will build a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Java CI with Maven

on:
  push:
    branches: [ main ] # , 2022-09, 2022-06 ]
  pull_request:
    branches: [ main ] # , 2022-09, 2022-06 ]

jobs:
  build:
    permissions:
      contents: write
      checks: write
      pull-requests: write
    runs-on: ubuntu-latest
    env:
      DISPLAY: :0
      MAVEN_OPTS: -Djava.awt.headless=true

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0 # required for jgit timestamp provider to work
    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'
    - run: |
          sudo apt-get update
          sudo apt-get install -y xvfb xauth \
           libgtk-3-0 libxext6 libxrender1 libxtst6 libxi6 libxrandr2 libxfixes3 \
           libasound2t64 libnss3 libgbm1
          sudo /usr/bin/Xvfb $DISPLAY -screen 0 1280x1024x24 &
    - name: Cache Maven dependencies
      uses: actions/cache@v5
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml', 'sandbox_target/*.target') }}
        restore-keys: ${{ runner.os }}-maven-
    - name: Set up Maven
      uses: stCarolas/setup-maven@d6af6abeda15e98926a57b5aa970a96bb37f97d1 # v5
      with:
        maven-version: 3.9.9
    - name: Build with Maven
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          # Fast PR build - skip product/repo for quick feedback
          xvfb-run --auto-servernum mvn -e -V -T 1C --batch-mode -Dtycho.localArtifacts=ignore clean verify
        else
          # Full build for main branch - includes product and repository
          xvfb-run --auto-servernum mvn -e -V -T 1C --batch-mode -Dtycho.localArtifacts=ignore -Pproduct,repo clean verify
        fi
#       run: xvfb-run --auto-servernum mvn -e -V --batch-mode -Dtycho.localArtifacts=ignore -Dinclude=web -Pjacoco clean verify
    - name: Cleanup xvfb pidx build
      uses: bcomnes/cleanup-xvfb@v1
    - name: Publish Test Report
      uses: mikepenz/action-junit-report@v6
      if: always() # always run even if the previous step fails
      with:
        report_paths: '**/target/surefire-reports/TEST-*.xml'
    - name: Generate HTML Test Reports
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        # Generate HTML test reports for all test modules
        failed_modules=""
        for module in sandbox_*_test; do
          if [ -d "$module" ]; then
            echo "Generating test report for $module..."
            if ! mvn -pl "$module" surefire-report:report-only; then
              echo "Error: Failed to generate report for $module"
              failed_modules="$failed_modules $module"
            fi
          fi
        done
        
        # Exit with error if any module failed to generate reports
        if [ -n "$failed_modules" ]; then
          echo "Failed to generate reports for:$failed_modules"
          exit 1
        fi
    - name: Prepare Test Reports for GitHub Pages
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        # Create directory structure for test reports
        mkdir -p /tmp/gh-pages/tests
        
        # Create an index.html for the tests directory
        cat > /tmp/gh-pages/tests/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Sandbox Test Reports</title>
          <style>
            body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
            h1 { color: #333; }
            .module { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
            .module h2 { margin-top: 0; color: #0066cc; }
            a { color: #0066cc; text-decoration: none; }
            a:hover { text-decoration: underline; }
            .description { color: #666; margin: 10px 0; }
          </style>
        </head>
        <body>
          <h1>Sandbox Test Reports</h1>
          <p class="description">
            This page contains HTML test reports for all test modules in the Sandbox project.
            Each module's report shows test results including passed, failed, and disabled tests.
          </p>
          <div class="modules">
        EOF
        
        # Copy test reports and add links to index
        for module in sandbox_*_test; do
          if [ -d "$module/target/site" ] && [ -f "$module/target/site/surefire-report.html" ]; then
            echo "Processing test report for $module..."
            # Copy the entire site directory to preserve resources
            mkdir -p "/tmp/gh-pages/tests/$module"
            cp -r "$module/target/site/"* "/tmp/gh-pages/tests/$module/"
            
            # Add module entry to index with HTML escaping for display text
            # Module names follow pattern sandbox_*_test (alphanumeric + underscore only)
            # so they're URL-safe and can be used directly in href
            # HTML-escape only for display text to prevent XSS
            module_escaped=$(echo "$module" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'\''/\&#39;/g')
            cat >> /tmp/gh-pages/tests/index.html << EOF
            <div class="module">
              <h2>${module_escaped}</h2>
              <p><a href="${module}/surefire-report.html">View Test Report</a></p>
            </div>
        EOF
          fi
        done
        
        # Close HTML
        cat >> /tmp/gh-pages/tests/index.html << 'EOF'
          </div>
          <hr>
          <p style="text-align: center; color: #666; margin-top: 30px;">
            Generated by <a href="https://github.com/carstenartur/sandbox">Sandbox Project</a> | 
            <a href="../coverage/">Coverage Reports</a>
          </p>
        </body>
        </html>
        EOF
        
        echo "Test reports prepared in /tmp/gh-pages/tests"
        ls -la /tmp/gh-pages/tests/
    - name: Upload Update Site Artifact
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v6
      with:
        name: update-site-repository
        path: sandbox_updatesite/target/repository/
        retention-days: 1
    - name: Deploy Coverage to GitHub Pages
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./sandbox_coverage/target/site/jacoco-aggregate
        destination_dir: coverage
        keep_files: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy JaCoCo coverage report'
    - name: Deploy Test Reports to GitHub Pages
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: /tmp/gh-pages/tests
        destination_dir: tests
        keep_files: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy test reports'
