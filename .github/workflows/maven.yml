# This workflow will build a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Java CI with Maven

on:
  push:
    branches: [ main ] # , 2022-09, 2022-06 ]
  pull_request:
    branches: [ main ] # , 2022-09, 2022-06 ]

jobs:
  build:
    permissions:
      contents: write
      checks: write
      pull-requests: write
    runs-on: ubuntu-latest
    env:
      DISPLAY: :0
      MAVEN_OPTS: -Djava.awt.headless=true

    steps:
    - uses: actions/checkout@v6
      with:
        fetch-depth: 0 # required for jgit timestamp provider to work
    - name: Debug GitHub context
      run: |
        echo "event_name: ${{ github.event_name }}"
        echo "ref: ${{ github.ref }}"
        echo "ref_name: ${{ github.ref_name }}"
        echo "head_ref: ${{ github.head_ref }}"
        echo "base_ref: ${{ github.base_ref }}"
    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'
    - run: |
          sudo apt-get update
          sudo apt-get install -y xvfb xauth \
           libgtk-3-0 libxext6 libxrender1 libxtst6 libxi6 libxrandr2 libxfixes3 \
           libasound2t64 libnss3 libgbm1
          sudo /usr/bin/Xvfb $DISPLAY -screen 0 1280x1024x24 &
    - name: Cache Maven dependencies
      uses: actions/cache@v5
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml', 'sandbox_target/*.target') }}
        restore-keys: ${{ runner.os }}-maven-
    - name: Set up Maven
      uses: stCarolas/setup-maven@d6af6abeda15e98926a57b5aa970a96bb37f97d1 # v5
      with:
        maven-version: 3.9.9
    - name: Build with Maven
      run: |
        # Normal Maven/Tycho build without jacoco, product, repo profiles by default
        # This ensures fast builds and test report generation on every commit
        xvfb-run --auto-servernum mvn -e -V -T 1C --batch-mode -Dtycho.localArtifacts=ignore clean verify
    - name: Cleanup xvfb pidx build
      uses: bcomnes/cleanup-xvfb@v1
    - name: Publish Test Report
      uses: mikepenz/action-junit-report@v6
      if: always() # always run even if the previous step fails
      with:
        report_paths: '**/target/surefire-reports/TEST-*.xml'
        summary: true
        include_passed: true
        detailed_summary: true
    - name: Generate HTML Test Reports
      if: github.event_name == 'push' && github.ref_name == 'main'
      run: |
        echo "=== Checking for test XML reports ==="
        find . -path "*/target/surefire-reports/TEST-*.xml" -type f | head -20
        
        echo ""
        echo "=== Generating HTML reports for each test module ==="
        # Generate reports for each test module individually
        for module in sandbox_*_test; do
          if [ -d "$module" ]; then
            echo "Generating report for $module..."
            # Check if XML reports exist for this module
            if ls "$module/target/surefire-reports/TEST-"*.xml 1> /dev/null 2>&1; then
              mvn surefire-report:report-only -DlinkXRef=false -pl "$module" --batch-mode || echo "Warning: Failed to generate report for $module"
            else
              echo "No test XML files found for $module, skipping..."
            fi
          fi
        done
        
        echo ""
        echo "=== Checking generated HTML reports ==="
        find . -path "*/target/site/surefire-report.html" -type f
    - name: Prepare Test Reports for GitHub Pages
      if: github.event_name == 'push' && github.ref_name == 'main'
      run: |
        # Create directory structure for test reports
        mkdir -p /tmp/gh-pages/tests
        
        # Track if we found any reports
        found_reports=false
        
        # Create an index.html for the tests directory
        cat > /tmp/gh-pages/tests/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Sandbox Test Reports</title>
          <style>
            body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
            h1 { color: #333; }
            .module { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
            .module h2 { margin-top: 0; color: #0066cc; }
            a { color: #0066cc; text-decoration: none; }
            a:hover { text-decoration: underline; }
            .description { color: #666; margin: 10px 0; }
            .no-reports { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; }
          </style>
        </head>
        <body>
          <h1>Sandbox Test Reports</h1>
          <p class="description">
            This page contains HTML test reports for all test modules in the Sandbox project.
            Each module's report shows test results including passed, failed, and disabled tests.
          </p>
          <div class="modules">
        EOF
        
        # Copy test reports and add links to index
        for module in sandbox_*_test; do
          echo "Checking $module for reports..."
          
          # Check multiple possible locations for the report
          report_file=""
          if [ -f "$module/target/site/surefire-report.html" ]; then
            report_file="$module/target/site/surefire-report.html"
          elif [ -f "$module/target/surefire-reports/surefire-report.html" ]; then
            report_file="$module/target/surefire-reports/surefire-report.html"
          fi
          
          if [ -n "$report_file" ]; then
            echo "Found report for $module at $report_file"
            found_reports=true
            
            # Copy the entire site directory to preserve resources
            mkdir -p "/tmp/gh-pages/tests/$module"
            if [ -d "$module/target/site" ]; then
              cp -r "$module/target/site/"* "/tmp/gh-pages/tests/$module/" 2>/dev/null || true
            fi
            
            # Ensure the report file is copied
            cp "$report_file" "/tmp/gh-pages/tests/$module/surefire-report.html" 2>/dev/null || true
            
            # Add module entry to index
            module_escaped=$(echo "$module" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g; s/'\''/\&#39;/g')
            cat >> /tmp/gh-pages/tests/index.html << EOF
            <div class="module">
              <h2>${module_escaped}</h2>
              <p><a href="${module}/surefire-report.html">View Test Report</a></p>
            </div>
        EOF
          else
            echo "No report found for $module"
            # Check if XML reports exist (tests ran but HTML not generated)
            if ls "$module/target/surefire-reports/TEST-"*.xml 1> /dev/null 2>&1; then
              echo "  (XML reports exist but HTML was not generated)"
            fi
          fi
        done
        
        # If no reports found, add a message
        if [ "$found_reports" = false ]; then
          echo "WARNING: No HTML test reports were found!"
          cat >> /tmp/gh-pages/tests/index.html << 'EOF'
            <div class="no-reports">
              <strong>⚠️ No test reports available yet.</strong>
              <p>Test reports will appear here after a successful build with test execution.</p>
              <p>Check the <a href="https://github.com/carstenartur/sandbox/actions">GitHub Actions</a> for build status.</p>
            </div>
        EOF
        fi
        
        # Close HTML
        cat >> /tmp/gh-pages/tests/index.html << 'EOF'
          </div>
          <hr>
          <p style="text-align: center; color: #666; margin-top: 30px;">
            Generated by <a href="https://github.com/carstenartur/sandbox">Sandbox Project</a> | 
            <a href="../coverage/">Coverage Reports</a>
          </p>
        </body>
        </html>
        EOF
        
        echo ""
        echo "=== Test reports prepared ==="
        ls -la /tmp/gh-pages/tests/
        echo ""
        echo "=== Index.html content ==="
        cat /tmp/gh-pages/tests/index.html
    - name: Deploy Test Reports to GitHub Pages
      if: github.event_name == 'push' && github.ref_name == 'main'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: /tmp/gh-pages/tests
        destination_dir: tests
        keep_files: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy test reports'
