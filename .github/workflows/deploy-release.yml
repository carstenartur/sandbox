name: Release Workflow

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., 1.2.2)'
        required: true
        type: string
      next_snapshot_version:
        description: 'Next SNAPSHOT version (e.g., 1.2.3-SNAPSHOT)'
        required: true
        type: string

permissions:
  contents: write  # Required to push to main branch, create tags, and push to gh-pages
  issues: read     # Required to read issues for release notes

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout with full history
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Full history required for git describe and jgit timestamp provider

    # 2. Set up JDK 21
    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'

    # Cache Maven dependencies for faster builds
    - name: Cache Maven dependencies
      uses: actions/cache@v5
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-maven-

    # 3. Set release version using tycho-versions-plugin
    - name: Set release version
      run: |
        echo "Setting version to ${{ inputs.release_version }}"
        mvn tycho-versions:set-version -DnewVersion=${{ inputs.release_version }}

    # 4. Verify version update - fail if any SNAPSHOT versions remain
    - name: Verify version update
      run: |
        echo "Checking for remaining SNAPSHOT references..."
        if grep -r "SNAPSHOT" --include="pom.xml" --include="MANIFEST.MF" --include="feature.xml" --include="*.product" . | grep -v "sandbox-functional-converter-core"; then
          echo "ERROR: Found remaining SNAPSHOT references (excluding sandbox-functional-converter-core)"
          exit 1
        fi
        echo "Version verification passed - no unexpected SNAPSHOT references found"

    # 5. Commit version changes
    - name: Commit version changes
      run: |
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        git add -A
        git commit -m "Release version ${{ inputs.release_version }}"

    # 6. Build and verify
    - name: Build and verify
      run: |
        echo "Building release ${{ inputs.release_version }}..."
        mvn clean verify -DskipTests

    # 7. Create Git tag
    - name: Create Git tag
      run: |
        git tag -a "v${{ inputs.release_version }}" -m "Release version ${{ inputs.release_version }}"
        echo "Created tag v${{ inputs.release_version }}"

    # 8. Create maintenance branch
    - name: Create maintenance branch
      run: |
        # Extract major.minor from version (e.g., 1.2.2 -> 1.2)
        MAJOR_MINOR=$(echo "${{ inputs.release_version }}" | sed 's/\.[^.]*$//')
        echo "Creating maintenance branch: maintenance/${MAJOR_MINOR}.x"
        git branch "maintenance/${MAJOR_MINOR}.x" || echo "Branch maintenance/${MAJOR_MINOR}.x already exists"

    # 9. Deploy release to gh-pages
    - name: Checkout gh-pages branch
      uses: actions/checkout@v6
      with:
        ref: gh-pages
        path: gh-pages-repo

    - name: Prepare release directory
      run: |
        mkdir -p gh-pages-repo/releases/${{ inputs.release_version }}
        cp -r sandbox_updatesite/target/repository/* gh-pages-repo/releases/${{ inputs.release_version }}/

    - name: Update composite metadata
      run: |
        cd gh-pages-repo/releases
        
        # Get list of all release versions
        VERSIONS=$(find . -maxdepth 1 -type d ! -name '.' ! -name '..' -exec basename {} \; | sort -V)
        VERSION_COUNT=$(echo "$VERSIONS" | wc -l)
        
        # Generate children elements for composite metadata
        CHILDREN_XML=""
        for ver in $VERSIONS; do
          CHILDREN_XML="$CHILDREN_XML    <child location='$ver'/>\n"
        done
        
        # Create compositeContent.xml
        cat > compositeContent.xml << EOF
        <?xml version='1.0' encoding='UTF-8'?>
        <?compositeMetadataRepository version='1.0.0'?>
        <repository name='Sandbox Releases'
                    type='org.eclipse.equinox.internal.p2.metadata.repository.CompositeMetadataRepository'
                    version='1.0.0'>
          <properties size='1'>
            <property name='p2.timestamp' value='$(date +%s)000'/>
          </properties>
          <children size='$VERSION_COUNT'>
        $(echo -e "$CHILDREN_XML")  </children>
        </repository>
        EOF
        
        # Create compositeArtifacts.xml
        cat > compositeArtifacts.xml << EOF
        <?xml version='1.0' encoding='UTF-8'?>
        <?compositeArtifactRepository version='1.0.0'?>
        <repository name='Sandbox Releases'
                    type='org.eclipse.equinox.internal.p2.artifact.repository.CompositeArtifactRepository'
                    version='1.0.0'>
          <properties size='1'>
            <property name='p2.timestamp' value='$(date +%s)000'/>
          </properties>
          <children size='$VERSION_COUNT'>
        $(echo -e "$CHILDREN_XML")  </children>
        </repository>
        EOF
        
        echo "Created composite metadata for $VERSION_COUNT versions"

    - name: Commit and push to gh-pages
      run: |
        cd gh-pages-repo
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        git add .
        git commit -m "Deploy release ${{ inputs.release_version }}"
        git push origin gh-pages

    # 10. Generate release notes from closed issues
    - name: Generate release notes
      run: |
        echo "Generating release notes from closed issues..."
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "Getting closed issues since $PREVIOUS_TAG"
          PREVIOUS_DATE=$(git log -1 --format=%aI $PREVIOUS_TAG)
          gh issue list --state closed --search "closed:>$PREVIOUS_DATE" --json number,title --jq '.[] | "- #\(.number): \(.title)"' > release_notes.md || echo "No closed issues found"
        else
          echo "No previous tag found - first release"
          echo "Initial release" > release_notes.md
        fi
        
        echo "Release notes generated:"
        cat release_notes.md

    # 11. Create GitHub Release
    - name: Create GitHub Release
      run: |
        echo "Creating GitHub release for v${{ inputs.release_version }}..."
        gh release create "v${{ inputs.release_version }}" \
          --title "Release ${{ inputs.release_version }}" \
          --notes-file release_notes.md \
          --generate-notes

    # 12. Bump to next SNAPSHOT version
    - name: Bump to next SNAPSHOT version
      run: |
        echo "Bumping version to ${{ inputs.next_snapshot_version }}"
        mvn tycho-versions:set-version -DnewVersion=${{ inputs.next_snapshot_version }}

    # 13. Commit and push SNAPSHOT version and tags
    - name: Commit and push SNAPSHOT version
      run: |
        git add -A
        git commit -m "Prepare for next development iteration ${{ inputs.next_snapshot_version }}"
        
        # Push main branch with SNAPSHOT version
        git push origin main
        
        # Push the release tag
        git push origin "v${{ inputs.release_version }}"
        
        # Push maintenance branch (don't fail if already exists on remote)
        MAJOR_MINOR=$(echo "${{ inputs.release_version }}" | sed 's/\.[^.]*$//')
        git push origin "maintenance/${MAJOR_MINOR}.x" || echo "Maintenance branch already exists on remote"

    # 14. Add Eclipse Marketplace reminder
    - name: Eclipse Marketplace reminder
      run: |
        echo "::notice::Remember to update the Eclipse Marketplace listing at https://marketplace.eclipse.org/ with the new update site URL: https://carstenartur.github.io/sandbox/releases/${{ inputs.release_version }}/"
