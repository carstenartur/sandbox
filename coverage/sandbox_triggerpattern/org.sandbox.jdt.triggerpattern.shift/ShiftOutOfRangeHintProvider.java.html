<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ShiftOutOfRangeHintProvider.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">sandbox_coverage</a> &gt; <a href="../index.html" class="el_bundle">sandbox_triggerpattern</a> &gt; <a href="index.source.html" class="el_package">org.sandbox.jdt.triggerpattern.shift</a> &gt; <span class="el_source">ShiftOutOfRangeHintProvider.java</span></div><h1>ShiftOutOfRangeHintProvider.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2026 Carsten Hammer.
 *
 * This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License 2.0
 * which accompanies this distribution, and is available at
 * https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 *     Carsten Hammer
 *******************************************************************************/
package org.sandbox.jdt.triggerpattern.shift;

import org.eclipse.jdt.core.dom.AST;
import org.eclipse.jdt.core.dom.ASTNode;
import org.eclipse.jdt.core.dom.Expression;
import org.eclipse.jdt.core.dom.ITypeBinding;
import org.eclipse.jdt.core.dom.InfixExpression;
import org.eclipse.jdt.core.dom.NumberLiteral;
import org.eclipse.jdt.ui.text.java.IJavaCompletionProposal;
import org.eclipse.jdt.ui.text.java.correction.ASTRewriteCorrectionProposal;
import org.eclipse.swt.graphics.Image;
import org.sandbox.jdt.triggerpattern.api.Hint;
import org.sandbox.jdt.triggerpattern.api.HintContext;
import org.sandbox.jdt.triggerpattern.api.PatternKind;
import org.sandbox.jdt.triggerpattern.api.TriggerPattern;

/**
 * Hint provider for shift out of range detection using TriggerPattern.
 *
 * &lt;p&gt;In Java, shift amounts are automatically masked:&lt;/p&gt;
 * &lt;ul&gt;
 * &lt;li&gt;For {@code int} (and {@code byte}, {@code short}, {@code char}): {@code amount &amp; 0x1f} (range 0-31)&lt;/li&gt;
 * &lt;li&gt;For {@code long}: {@code amount &amp; 0x3f} (range 0-63)&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;This hint detects out-of-range shift amounts and suggests replacing them
 * with the effective masked value.&lt;/p&gt;
 *
 * &lt;p&gt;Inspired by
 * &lt;a href=&quot;https://github.com/apache/netbeans/blob/master/java/java.hints/src/org/netbeans/modules/java/hints/ShiftOutOfRange.java&quot;&gt;
 * NetBeans ShiftOutOfRange&lt;/a&gt;.&lt;/p&gt;
 *
 * @since 1.2.5
 */
<span class="nc" id="L48">public class ShiftOutOfRangeHintProvider {</span>

	private static final int INT_SHIFT_MASK = 31;
	private static final int LONG_SHIFT_MASK = 63;

	/**
	 * Detects {@code $v &lt;&lt; $c} where $c is out of range.
	 *
	 * @param ctx the hint context
	 * @return a completion proposal, or null if not applicable
	 */
	@TriggerPattern(value = &quot;$v &lt;&lt; $c&quot;, kind = PatternKind.EXPRESSION)
	@Hint(displayName = &quot;Shift left amount out of range&quot;,
	      description = &quot;The shift amount is out of the valid range and will be masked by Java&quot;)
	public static IJavaCompletionProposal checkLeftShift(HintContext ctx) {
<span class="nc" id="L63">		return checkShiftOutOfRange(ctx);</span>
	}

	/**
	 * Detects {@code $v &gt;&gt; $c} where $c is out of range.
	 *
	 * @param ctx the hint context
	 * @return a completion proposal, or null if not applicable
	 */
	@TriggerPattern(value = &quot;$v &gt;&gt; $c&quot;, kind = PatternKind.EXPRESSION)
	@Hint(displayName = &quot;Signed right shift amount out of range&quot;,
	      description = &quot;The shift amount is out of the valid range and will be masked by Java&quot;)
	public static IJavaCompletionProposal checkRightShiftSigned(HintContext ctx) {
<span class="nc" id="L76">		return checkShiftOutOfRange(ctx);</span>
	}

	/**
	 * Detects {@code $v &gt;&gt;&gt; $c} where $c is out of range.
	 *
	 * @param ctx the hint context
	 * @return a completion proposal, or null if not applicable
	 */
	@TriggerPattern(value = &quot;$v &gt;&gt;&gt; $c&quot;, kind = PatternKind.EXPRESSION)
	@Hint(displayName = &quot;Unsigned right shift amount out of range&quot;,
	      description = &quot;The shift amount is out of the valid range and will be masked by Java&quot;)
	public static IJavaCompletionProposal checkRightShiftUnsigned(HintContext ctx) {
<span class="nc" id="L89">		return checkShiftOutOfRange(ctx);</span>
	}

	private static IJavaCompletionProposal checkShiftOutOfRange(HintContext ctx) {
<span class="nc" id="L93">		ASTNode matchedNode = ctx.getMatch().getMatchedNode();</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">		if (!(matchedNode instanceof InfixExpression)) {</span>
<span class="nc" id="L95">			return null;</span>
		}

<span class="nc" id="L98">		InfixExpression infixExpr = (InfixExpression) matchedNode;</span>

		// Get the shift amount
<span class="nc" id="L101">		ASTNode cNode = ctx.getMatch().getBinding(&quot;$c&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L102" title="All 4 branches missed.">		if (cNode == null || !(cNode instanceof Expression)) {</span>
<span class="nc" id="L103">			return null;</span>
		}

<span class="nc" id="L106">		Expression shiftAmountExpr = (Expression) cNode;</span>
<span class="nc" id="L107">		Object constantValue = shiftAmountExpr.resolveConstantExpressionValue();</span>
<span class="nc bnc" id="L108" title="All 4 branches missed.">		if (constantValue == null || !(constantValue instanceof Number)) {</span>
<span class="nc" id="L109">			return null;</span>
		}
<span class="nc" id="L111">		long shiftAmount = ((Number) constantValue).longValue();</span>

		// Get the left operand type
<span class="nc" id="L114">		ASTNode vNode = ctx.getMatch().getBinding(&quot;$v&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L115" title="All 4 branches missed.">		if (vNode == null || !(vNode instanceof Expression)) {</span>
<span class="nc" id="L116">			return null;</span>
		}

<span class="nc" id="L119">		Expression leftOperand = (Expression) vNode;</span>
<span class="nc" id="L120">		ITypeBinding typeBinding = leftOperand.resolveTypeBinding();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">		if (typeBinding == null) {</span>
<span class="nc" id="L122">			return null;</span>
		}

<span class="nc" id="L125">		String qualifiedName = typeBinding.getQualifiedName();</span>
		long maskedValue;
<span class="nc bnc" id="L127" title="All 2 branches missed.">		boolean isIntLike = &quot;int&quot;.equals(qualifiedName) //$NON-NLS-1$</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">				|| &quot;byte&quot;.equals(qualifiedName) //$NON-NLS-1$</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">				|| &quot;short&quot;.equals(qualifiedName) //$NON-NLS-1$</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">				|| &quot;char&quot;.equals(qualifiedName) //$NON-NLS-1$</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">				|| &quot;java.lang.Integer&quot;.equals(qualifiedName) //$NON-NLS-1$</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">				|| &quot;java.lang.Byte&quot;.equals(qualifiedName) //$NON-NLS-1$</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">				|| &quot;java.lang.Short&quot;.equals(qualifiedName) //$NON-NLS-1$</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">				|| &quot;java.lang.Character&quot;.equals(qualifiedName); //$NON-NLS-1$</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">		boolean isLongLike = &quot;long&quot;.equals(qualifiedName) //$NON-NLS-1$</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">				|| &quot;java.lang.Long&quot;.equals(qualifiedName); //$NON-NLS-1$</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">		if (isIntLike) {</span>
<span class="nc bnc" id="L138" title="All 4 branches missed.">			if (shiftAmount &gt;= 0 &amp;&amp; shiftAmount &lt;= INT_SHIFT_MASK) {</span>
<span class="nc" id="L139">				return null; // in range</span>
			}
<span class="nc" id="L141">			maskedValue = shiftAmount &amp; INT_SHIFT_MASK;</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">		} else if (isLongLike) {</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">			if (shiftAmount &gt;= 0 &amp;&amp; shiftAmount &lt;= LONG_SHIFT_MASK) {</span>
<span class="nc" id="L144">				return null; // in range</span>
			}
<span class="nc" id="L146">			maskedValue = shiftAmount &amp; LONG_SHIFT_MASK;</span>
<span class="nc" id="L147">		} else {</span>
<span class="nc" id="L148">			return null;</span>
		}

		// Create the replacement
<span class="nc" id="L152">		AST ast = ctx.getASTRewrite().getAST();</span>
<span class="nc" id="L153">		NumberLiteral newLiteral = ast.newNumberLiteral(String.valueOf(maskedValue));</span>
<span class="nc" id="L154">		ctx.getASTRewrite().replace(infixExpr.getRightOperand(), newLiteral, null);</span>

<span class="nc" id="L156">		String label = &quot;Replace out-of-range shift amount &quot; + shiftAmount + &quot; with &quot; + maskedValue; //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L157">		ASTRewriteCorrectionProposal proposal = new ASTRewriteCorrectionProposal(</span>
<span class="nc" id="L158">			label,</span>
<span class="nc" id="L159">			ctx.getICompilationUnit(),</span>
<span class="nc" id="L160">			ctx.getASTRewrite(),</span>
<span class="nc" id="L161">			10,</span>
<span class="nc" id="L162">			(Image) null</span>
		);

<span class="nc" id="L165">		return proposal;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>